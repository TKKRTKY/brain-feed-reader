## 1. 要件定義書

**概要:**
本ドキュメントは、EPUB形式の電子書籍ファイルをアップロード・閲覧し、章やページごとに内容を要約できるウェブアプリケーションの要件を定義します。本システムはReact/TypeScript/Next.jsを用いて実装され、開発管理にAIエージェントツール「Cline」を利用します。まずMVP（Minimum Viable Product）としてEPUBフォーマットに限定した機能を提供し、将来的にPDFやMOBI等の対応やユーザー認証機能の追加を前提とします。

### 機能要件

* **EPUBファイルのアップロードと取込:** ユーザーはローカルのEPUBファイルを本アプリにアップロードできること。アップロード後、ファイル内容を解凍・解析して電子書籍の構造（目次や章立て）を取得する。対象フォーマットは現時点でEPUBのみ（MVP範囲）。将来的に他フォーマット（PDF, MOBI等）も取り込めるよう拡張可能な設計とする（他形式は現状未対応である旨をUI上で明示）。

* **電子書籍のWebビューアー表示:** アップロードされたEPUBの内容をブラウザ上で閲覧できること。最低限、テキスト本文を読みやすく表示し、章ごとにページ送りまたはスクロールで読めること。目次（TOC）を利用して特定の章にジャンプする機能を持たせる。ビューアーはまず基本的な実装とし、後から機能拡張（フォント調整、テーマ変更、画像対応等）しやすい構造にする。例えばReact用のEPUB表示ライブラリ（epub.jsのラッパーであるReact-Reader等）の利用を検討し、スムーズな組み込みを図る。

* **画面レイアウト構成:** 画面を目次、本文、要約/メモの3ペインで構成すること。各ペインはサイズ調整可能とし、ユーザーの好みに応じてカスタマイズできる。目次ペインでは本の目次構造を表示し、本文ペインでは現在の章を表示し、要約/メモペインでは選択範囲の要約や読書メモを表示する。LLM（要約AI）の設定はモーダルダイアログ形式で提供し、設定時の操作性を向上させる。レスポンシブ対応として、モバイル表示時はタブ切り替え方式でペインを切り替えられるようにする。

* **章・範囲指定での要約リクエスト:** 以下の2つの方法で要約範囲を指定できること：
  1. 章単位の指定：章タイトルまたは章番号で指定。例えば「第1章」や「章タイトル：Introduction」の指定で、その章の内容を要約対象とする。複数章（例：「第1章～第3章」）の一括要約も可能とする。
  2. ハイライト範囲の指定：本文中の任意の範囲をハイライト選択し、その部分のみを要約対象とする。選択範囲の前後のコンテキストも考慮した適切な要約を生成する。

* **要約結果の表示:** 要約要求に対し、指定範囲の本文テキストをAI要約APIへ送信し取得した要約結果を、アプリ上に表示する。要約結果は閲覧画面上で本文とは別エリアに表示し、ユーザーが読みやすい形式（段落やリストなど適切なフォーマット）で提示する。要約生成にはOpenAI互換のチャットAPIを使用し、例えばChatGPTのようなモデルに指定範囲のテキストを要約させる。ユーザーが連続して複数範囲の要約を依頼できるよう、インターフェース上で新規要約要求の入力と結果表示を繰り返し可能とする。

* **読書メモ機能:** 要約内容や読者の理解をメモとして記録できること。以下の機能を提供する：
  1. Markdownエディタ：メモの作成・編集をMarkdown形式で行える。基本的なMarkdown記法のツールバーを提供し、編集をサポートする。
  2. リアルタイムプレビュー：入力中のMarkdownをリアルタイムでプレビュー表示する。
  3. テンプレート生成：本の目次構造に基づいたメモテンプレートを自動生成する。各章や節に対応する見出しを自動で作成し、要約内容も適切な位置に配置する。
  4. エクスポート：作成したメモをMarkdown形式でエクスポートできる。必要に応じてPDF等の形式への変換オプションも提供する。

* **AI APIエンドポイントの指定:** 要約処理に利用するOpenAI Chat API互換のエンドポイントをユーザーが設定できること。本システムはAPIキーを内包しないため、ユーザー自身のAPIサービス（OpenAI公式APIや互換モデルのホスティング先など）をエンドポイントURLとして設定・変更できるようにする。例えば設定画面やフォームでAPIのベースURLやエンドポイントURL、および必要に応じてAPIキーや認証情報を入力し保存できる機能を提供する。デフォルトではエンドポイント未設定時に動作しない旨を通知し、ユーザーが有効なエンドポイントを設定した後に要約機能が利用可能となる。

### 非機能要件

* **拡張性:** 本アプリはMVPではEPUB閲覧・要約に限定した機能を持つが、今後PDFやMOBIといった他の電子書籍フォーマットへの対応を追加できる拡張性を確保する。コード構成をモジュール化し、ファイルフォーマットごとの処理（解析・ビューア表示）を分離する設計とする（例えばインタフェースを定義し、新しいフォーマット対応クラスを追加できるようにする）。またビューアーのUIも後から強化しやすいよう、章ナビゲーションやレンダリング部分をコンポーネント化しておく。

* **性能・容量:** アップロードできるEPUBファイルのサイズは、ブラウザで扱える範囲に制限する（MVP段階では具体的数値は決めず、大容量の場合は警告する程度）。ビューアー表示のパフォーマンスが極端に低下しないよう、一度にレンダリングするテキスト量を制御する（章単位の表示や仮想スクロールの活用など）。要約APIへのリクエストサイズも、モデルのトークン上限に収まるよう制御する。章が非常に長い場合は内部で分割し順次要約するか、要約範囲を調整・制限する戦略を取る可能性がある（OpenAIの研究でも長文書を小分割し段階的に要約する手法が取られている）。

* **ユーザビリティ:**
  - ログインや複雑な初期設定なしで誰でもすぐ使えること（MVPでは認証機能を搭載しない）
  - アップロードから閲覧、要約要求までの操作フローが直感的であること
  - 3ペインレイアウトでの操作が分かりやすく、ペインのサイズ調整が容易であること
  - ハイライト操作と要約リクエストがスムーズに連携していること
  - 読書メモの作成・編集が直感的で、Markdown初心者でも扱いやすいこと
  - エラーメッセージはユーザーに分かりやすい表現で表示すること

* **信頼性とエラーハンドリング:**
  - 想定外の入力やエラーに対する適切な処理
  - 破損したEPUBファイルをアップロードした場合のエラー検知とユーザー通知
  - 要約APIがエラーやタイムアウトを返した場合の再試行促しやエラーメッセージ表示
  - メモの自動保存と編集内容の復元機能
  - 要約履歴やメモの永続化（ブラウザのストレージ範囲内）

* **セキュリティ:**
  - アップロードファイルはブラウザ内で一時的に扱い、MVPではサーバに長期保存しない
  - ユーザーが指定するAPIキー等の機密情報は、安全に取り扱うこと
  - メモデータはローカルストレージに保存し、機密性の高い情報は含まないよう注意喚起する

### 前提条件・制約

* **対象プラットフォーム:** PCブラウザおよびモバイルブラウザ（主要な最新Chrome/Firefox/Safari等）で動作するウェブアプリとする。Next.jsによるSSR/SPAを活用し、PWA（プログレッシブウェブアプリ）への発展も視野に入れる。オフライン動作は当面考慮しないが、将来的に閲覧のみオフライン対応できるように検討する（例えばService Workerの利用）。

* **開発環境・技術スタック:** フロントエンドフレームワークはNext.js (React, TypeScript)を採用。要約APIはOpenAI Chat API互換のものであればベンダー問わず利用可能とする（OpenAI公式APIやAzure OpenAI、あるいは互換のローカルAIサービスなど）。Git等のバージョン管理下でClineを用いたAIペアプログラミング開発を行う前提。開発時はローカルで動作確認し、デプロイ先は後述のとおりGCP環境を予定する。

* **将来の機能追加:** PDFやMOBI対応、ユーザー認証（ログイン）機能、複数書籍のライブラリ管理などは将来のロードマップに含むが、本要件定義のスコープ外（対象外）とする。ただし設計段階でこれらを見越した構造とし、例えばユーザー認証を後付できるルーティング構成や、複数書籍管理を見据えたデータモデルを検討しておく。
