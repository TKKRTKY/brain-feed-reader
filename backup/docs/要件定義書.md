## 1. 要件定義書

**概要:**
本ドキュメントは、EPUB形式の電子書籍ファイルをアップロード・閲覧し、章やページごとに内容を要約できるウェブアプリケーションの要件を定義します。本システムはReact/TypeScript/Next.jsを用いて実装され、開発管理にAIエージェントツール「Cline」を利用します。まずMVP（Minimum Viable Product）としてEPUBフォーマットに限定した機能を提供し、将来的にPDFやMOBI等の対応やユーザー認証機能の追加を前提とします。

### 機能要件

* **EPUBファイルのアップロードと取込:** ユーザーはローカルのEPUBファイルを本アプリにアップロードできること。アップロード後、ファイル内容を解凍・解析して電子書籍の構造（目次や章立て）を取得する。対象フォーマットは現時点でEPUBのみ（MVP範囲）。将来的に他フォーマット（PDF, MOBI等）も取り込めるよう拡張可能な設計とする（他形式は現状未対応である旨をUI上で明示）。
* **電子書籍のWebビューアー表示:** アップロードされたEPUBの内容をブラウザ上で閲覧できること。最低限、テキスト本文を読みやすく表示し、章ごとにページ送りまたはスクロールで読めること。目次（TOC）を利用して特定の章にジャンプする機能を持たせる。ビューアーはまず基本的な実装とし、後から機能拡張（フォント調整、テーマ変更、画像対応等）しやすい構造にする。例えばReact用のEPUB表示ライブラリ（epub.jsのラッパーであるReact-Reader等）の利用を検討し、スムーズな組み込みを図る。
* **章・ページ単位での要約リクエスト:** ユーザーが閲覧中の電子書籍に対し、特定の章またはページ範囲を指定して要約を要求できること。指定方法は章タイトルまたは章番号、あるいはページ番号で行えるようにする。例えば「第1章」や「章タイトル：Introduction」、あるいは「ページ5～10」などの指定で、その範囲の内容を要約対象とする。章範囲指定（例：「第1章～第3章」）にも対応し、複数章にまたがる内容も一括で要約可能とする。
* **要約結果の表示:** 要約要求に対し、指定範囲の本文テキストをAI要約APIへ送信し取得した要約結果を、アプリ上に表示する。要約結果は閲覧画面上で本文とは別エリアに表示し、ユーザーが読みやすい形式（段落やリストなど適切なフォーマット）で提示する。要約生成にはOpenAI互換のチャットAPIを使用し、例えばChatGPTのようなモデルに指定範囲のテキストを要約させる。ユーザーが連続して複数範囲の要約を依頼できるよう、インターフェース上で新規要約要求の入力と結果表示を繰り返し可能とする。
* **AI APIエンドポイントの指定:** 要約処理に利用するOpenAI Chat API互換のエンドポイントをユーザーが設定できること。本システムはAPIキーを内包しないため、ユーザー自身のAPIサービス（OpenAI公式APIや互換モデルのホスティング先など）をエンドポイントURLとして設定・変更できるようにする。例えば設定画面やフォームでAPIのベースURLやエンドポイントURL、および必要に応じてAPIキーや認証情報を入力し保存できる機能を提供する。デフォルトではエンドポイント未設定時に動作しない旨を通知し、ユーザーが有効なエンドポイントを設定した後に要約機能が利用可能となる。

### 非機能要件

* **拡張性:** 本アプリはMVPではEPUB閲覧・要約に限定した機能を持つが、今後PDFやMOBIといった他の電子書籍フォーマットへの対応を追加できる拡張性を確保する。コード構成をモジュール化し、ファイルフォーマットごとの処理（解析・ビューア表示）を分離する設計とする（例えばインタフェースを定義し、新しいフォーマット対応クラスを追加できるようにする）。またビューアーのUIも後から強化しやすいよう、章ナビゲーションやレンダリング部分をコンポーネント化しておく。
* **性能・容量:** アップロードできるEPUBファイルのサイズは、ブラウザで扱える範囲に制限する（MVP段階では具体的数値は決めず、大容量の場合は警告する程度）。ビューアー表示のパフォーマンスが極端に低下しないよう、一度にレンダリングするテキスト量を制御する（章単位の表示や仮想スクロールの活用など）。要約APIへのリクエストサイズも、モデルのトークン上限に収まるよう制御する。章が非常に長い場合は内部で分割し順次要約するか、要約範囲を調整・制限する戦略を取る可能性がある（OpenAIの研究でも長文書を小分割し段階的に要約する手法が取られている）。
* **ユーザビリティ:** ログインや複雑な初期設定なしで誰でもすぐ使えること（MVPでは認証機能を搭載しない）。アップロードから閲覧、要約要求までの操作フローが直感的であること。例えば、ファイル選択後自動でビューアーモードに切り替わり、画面上に要約入力フォーム（章やページ指定と実行ボタン）を配置する。エラーメッセージもユーザーに分かりやすい表現で表示する（例：対応外のファイル形式をアップした場合「現在EPUBのみ対応です」と通知）。
* **信頼性とエラーハンドリング:** 想定外の入力やエラーに対する適切な処理。たとえば破損したEPUBファイルをアップロードした場合のエラー検知とユーザー通知、要約APIがエラーやタイムアウトを返した場合の再試行促しやエラーメッセージ表示。要約APIへのリクエスト中はロード中インジケータを表示し、結果受信までUIがフリーズしないようにする。
* **セキュリティ:** ユーザーアップロードファイルはブラウザ内またはサーバ上で一時的に扱うが、MVPではユーザーごとのデータをサーバに長期保存しない（サーバに保存しない場合はブラウザメモリ上で処理を完結）。ユーザーが指定するAPIキー等の機密情報は、安全に取り扱うこと（ブラウザ上の設定の場合はローカルストレージやCookieではなく、セッション中のメモリ保持や都度入力など漏洩リスクを低減する方法を検討）。今後ログイン機能を導入する際には、ユーザーごとのファイルや設定を保護できる認証・認可機構を追加する。

### 前提条件・制約

* **対象プラットフォーム:** PCブラウザおよびモバイルブラウザ（主要な最新Chrome/Firefox/Safari等）で動作するウェブアプリとする。Next.jsによるSSR/SPAを活用し、PWA（プログレッシブウェブアプリ）への発展も視野に入れる。オフライン動作は当面考慮しないが、将来的に閲覧のみオフライン対応できるように検討する（例えばService Workerの利用）。
* **開発環境・技術スタック:** フロントエンドフレームワークはNext.js (React, TypeScript)を採用。要約APIはOpenAI Chat API互換のものであればベンダー問わず利用可能とする（OpenAI公式APIやAzure OpenAI、あるいは互換のローカルAIサービスなど）。Git等のバージョン管理下でClineを用いたAIペアプログラミング開発を行う前提。開発時はローカルで動作確認し、デプロイ先は後述のとおりGCP環境を予定する。
* **将来の機能追加:** PDFやMOBI対応、ユーザー認証（ログイン）機能、ブックマーク・ハイライト機能、複数書籍のライブラリ管理などは将来のロードマップに含むが、本要件定義のスコープ外（対象外）とする。ただし設計段階でこれらを見越した構造とし、例えばユーザー認証を後付できるルーティング構成や、複数書籍管理を見据えたデータモデルを検討しておく。
